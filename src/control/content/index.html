<!DOCTYPE html>
<html ng-app="textPlugin">

<head lang="en">
    <meta charset="UTF-8">

    <!-- CSS -->
    <link href="../../../../styles/helper.css" rel="stylesheet">
    <link href="../../../../styles/siteIcons.css" rel="stylesheet">

    <!-- JS -->
    <script src="../../../../scripts/buildfire.js"></script>
    <script src="../../../../scripts/angular/angular.min.js"></script>
    <script src="../../../../scripts/tinymce/tinymce.min.js"></script>
    <script src="../../../../scripts/tinymce/ui-tinymce.js"></script>

    <script src="../../../../scripts/jquery/jquery-1.11.2.min.js"></script>
    <script src="../../../../scripts/sortable.min.js"></script>
    <script src="../../../../scripts/buildfire/components/carousel/carousel.js"></script>
    <script src="../../../../scripts/buildfire/components/aiStateSeeder/aiStateSeeder.js"></script>

</head>

<body ng-controller="textPluginCtrl" id="textApp">
    <div ng-form="frmMain" ng-class="{'hidden': showContent === false}">
        <div id="carousel"></div>
        <hr class="none">
        <div class="item clearfix row">
            <div class="labels col-md-3 padding-right-zero pull-left">
                <span>Text</span>
            </div>
        </div>
        <hr class="none">
        <div class="item clearfix row">
            <div class="main col-md-12 pull-left">
                <textarea id="text" ui-tinymce="editorOptions" class="form-control" rows="5" width="100%" ng-model="data.content.text"></textarea>
            </div>
        </div>
    </div>

    <script>
        var textPluginApp = angular.module('textPlugin', [ 'ui.tinymce' ]);

        textPluginApp.controller('textPluginCtrl', ['$scope', function ($scope) {
            var datastoreInitialized = false;

            $scope.editorOptions = {
                plugins: 'advlist autolink link image lists charmap print preview',
                skin: 'lightgray',
                trusted: true,
                theme: 'modern',
                format: 'html',
                convert_urls : false,
                relative_urls : false

            };

            $scope.data = {
                content: {
                    carouselImages: [],
                    text: "<p>&nbsp;<br></p>"
                },
                design: {
                    backgroundImage: null,
                    backgroundBlur: 0,
                    selectedLayout: 1
                }
            };

            $scope.showContent = false;

            var showAISeeder = function() {
                let seeder = new buildfire.components.aiStateSeeder({
                        generateOptions: {
                            userMessage: 'Write a sample article about the [topic]',
                            systemMessage: 'Article should utilize images, figures, statistics. Article length should be less then 400 characters. For carousel images use source.unsplash.com',
                            jsonTemplate: {
                                content: {
                                    carouselImages: [],
                                    text: ""
                                }
                            },
                        },
                        importOptions: {
                            jsonTemplate: {
                                content: {
                                    carouselImages: [],
                                    text: ""
                                }
                            },
                            sampleCsv: `https://source.unsplash.com/featured/?music, <h1>The Magic of Music</h1><div class="image"><img src="https://source.unsplash.com/featured/?music" alt="Music Image"></div><p>Music is a universal language that touches the hearts and souls of people all around the world. It has the power to evoke emotions, bring back memories, and create a sense of connection among individuals. Whether you're listening to your favorite tunes, playing an instrument, or attending a live concert, music has a way of transporting you to a different world.</p><p>Music can be found in various genres, each with its own unique style and characteristics. From classical masterpieces to upbeat pop songs, from soulful jazz melodies to energetic rock anthems, there's something for everyone's taste. It's incredible how a simple arrangement of notes and lyrics can stir up feelings of joy, sadness, excitement, or nostalgia.</p><p>Moreover, music has the ability to bring people together. It serves as a common ground where individuals from different cultures and backgrounds can find commonality and share their love for melodies and rhythms. Whether you're jamming with friends, joining a choir, or attending a music festival, music fosters a sense of community and unity.</p><p>So, let the power of music surround you. Explore new artists, discover different genres, and let the melodies guide your emotions. Whether you're seeking solace, motivation, or simply a form of entertainment, music will always be there to accompany you on your journey.</p>`,
                            systemMessage: `For blog post images use dummyimages.com. For carousel images, generate small array of image urls based on topic, use source.unsplash.com for image URLs.`,
                        }
                    }).smartShowEmptyState(null, (err, result) => {
                        $scope.$apply(function () {
                            $scope.showContent = true;
                            if (seeder.requestType === 'generate') {
                                $scope.data.content = {
                                    carouselImages: result.data.content.carouselImages.map(el => { return { iconUrl: el, action: "noAction", title: "image" } }),
                                    text: result.data.content.text
                                }
                            } else {
                                $scope.data.content = {
                                    carouselImages: $scope.data.content.carouselImages.concat(result.data.content.carouselImages.map(el => { return { iconUrl: el, action: "noAction", title: "image" } })),
                                    text: $scope.data.content.text + result.data.content.text
                                }
                            }

                            editor.loadItems($scope.data.content.carouselImages);
                            seeder.requestResult.complete();
                        });
                    });
                    $scope.showContent = true;
            }

            // create a new instance of the buildfire carousel editor
            var editor = new buildfire.components.carousel.editor("#carousel");

            /*
             * Go pull any previously saved data
             * */
            buildfire.datastore.get(function (err, result) {

                if (!err) {
                    datastoreInitialized = true;
                } else {
                    console.error("Error: ", err);
                    return;
                }
                if (Object.keys(result.data).length && result.data.content.carouselImages.length > 0 && result.data.content.text) {
                    if (!result.data.design) result.data.design = $scope.data.design;
                    $scope.data = result.data;
                    $scope.id = result.id;
                    if ($scope.data.content && $scope.data.content.carouselImages)
                        editor.loadItems($scope.data.content.carouselImages);
                    if (tmrDelay) clearTimeout(tmrDelay);
                    $scope.showContent = true;
                } else {
                    showAISeeder();
                }

                /*
                 * watch for changes in data and trigger the saveDataWithDelay function on change
                 * */
                $scope.$watch('data', saveDataWithDelay, true);

                if (!$scope.$$phase && !$scope.$root.$$phase) {
                    $scope.$apply();
                }
            });

            /*
             * Call the datastore to save the data object
             */
            var saveData = function (newObj) {
                if (!datastoreInitialized) {
                    console.error("Error with datastore didn't get called");
                    return;
                }
                if(newObj.content.text.indexOf("src=\"//")!=-1){
                    newObj.content.text= newObj.content.text.replace("src=\"//","src=\"https://")
                }
                if (newObj == undefined) return;

                if ($scope.frmMain.$invalid) {
                    console.warn('invalid data, details will not be saved');
                    return;
                }

                if (!newObj.content || !newObj.design)
                    return;

                buildfire.datastore.save(newObj, function (err, result) {
                    if (err || !result) {
                        console.error('Error saving the widget details: ', err);
                    }
                    else {
                        console.info('Widget details saved');
                    }
                });
            };

            /*
             * create an artificial delay so api isnt called on every character entered
             * */
            var tmrDelay = null;
            var saveDataWithDelay = function (newObj, oldObj) {
                if (tmrDelay) clearTimeout(tmrDelay);
                if (angular.equals(newObj, oldObj)) return;
                tmrDelay = setTimeout(function () {
                    saveData(newObj);
                }, 500);
            };

            // this method will be called when a new item added to the list
            editor.onAddItems = editor.onDeleteItem = editor.onItemChange = editor.onOrderChange = function () {
                $scope.data.content.carouselImages = editor.items;
                saveData($scope.data);
            };

        }]);
    </script>
</body>
</html>